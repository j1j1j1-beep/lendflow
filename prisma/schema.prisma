generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Organizations & Users ────────────────────────────────────────────────────

model Organization {
  id         String   @id @default(cuid())
  name       String
  clerkOrgId String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  users      User[]
  deals      Deal[]
  subscription Subscription?
  usageLogs  UsageLog[]
}

// ─── Billing ──────────────────────────────────────────────────────────────────

model Subscription {
  id                   String    @id @default(cuid())
  orgId                String    @unique
  org                  Organization @relation(fields: [orgId], references: [id])
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  licensePaid          Boolean   @default(false)
  licensePaymentId     String?
  plan                 String    @default("trial") // "trial", "active", "canceled"
  status               String    @default("trialing") // "trialing", "active", "past_due", "canceled", "unpaid"
  maxSeats             Int       @default(25)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model UsageLog {
  id             String       @id @default(cuid())
  orgId          String
  org            Organization @relation(fields: [orgId], references: [id])
  month          String       // "2026-02" format
  dealsProcessed Int          @default(0)
  docsGenerated  Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([orgId, month])
}

model User {
  id        String       @id @default(cuid())
  clerkId   String       @unique
  email     String
  name      String
  role      String       @default("loan_officer")
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id])
  deals     Deal[]
  createdAt DateTime     @default(now())
}

// ─── Deals ────────────────────────────────────────────────────────────────────

model Deal {
  id              String     @id @default(cuid())
  borrowerName    String
  loanAmount      Decimal?   @db.Decimal(12, 2)
  loanPurpose     String?
  loanType        String?
  loanProgramId   String?
  selectedOutputDocs  String[]  @default([])
  proposedRate    Float?
  proposedTerm    Int?
  propertyAddress String?
  status          DealStatus @default(UPLOADED)
  errorMessage    String?
  errorStep       String?

  orgId  String
  org    Organization @relation(fields: [orgId], references: [id])
  userId String
  user   User         @relation(fields: [userId], references: [id])

  documents          Document[]
  extractions        Extraction[]
  analysis           Analysis?
  creditMemo         CreditMemo?
  verificationReport VerificationReport?
  reviewItems        ReviewItem[]
  dealTerms          DealTerms?
  propertyDetails    PropertyDetails?
  generatedDocuments GeneratedDocument[]
  conditions         Condition[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DealStatus {
  UPLOADED
  PROCESSING_OCR
  CLASSIFYING
  EXTRACTING
  VERIFYING
  RESOLVING
  NEEDS_REVIEW
  ANALYZING
  GENERATING_MEMO
  STRUCTURING
  NEEDS_TERM_REVIEW
  GENERATING_DOCS
  COMPLETE
  ERROR
}

// ─── Documents ────────────────────────────────────────────────────────────────

model Document {
  id             String         @id @default(cuid())
  dealId         String
  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  fileName       String
  s3Key          String
  fileSize       Int
  pageCount      Int?
  docType        DocType?
  docYear        Int?
  status         DocumentStatus @default(PENDING)
  isScanned      Boolean        @default(false)
  textractOutput Json?
  ocrText        String?        @db.Text
  extractions    Extraction[]
  createdAt      DateTime       @default(now())
}

enum DocType {
  FORM_1040
  FORM_1120
  FORM_1120S
  FORM_1065
  SCHEDULE_K1
  W2
  BANK_STATEMENT_CHECKING
  BANK_STATEMENT_SAVINGS
  PROFIT_AND_LOSS
  BALANCE_SHEET
  RENT_ROLL
  OTHER
}

enum DocumentStatus {
  PENDING
  OCR_PROCESSING
  OCR_COMPLETE
  CLASSIFYING
  CLASSIFIED
  EXTRACTING
  EXTRACTED
  VERIFIED
  ERROR
}

// ─── Extractions ──────────────────────────────────────────────────────────────

model Extraction {
  id               String   @id @default(cuid())
  documentId       String
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  dealId           String
  deal             Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  model            String
  promptVersion    String
  rawResponse      Json
  structuredData   Json
  validationErrors Json?
  tokensUsed       Int      @default(0)
  costUsd          Float    @default(0)
  createdAt        DateTime @default(now())
}

// ─── Verification ─────────────────────────────────────────────────────────────

model VerificationReport {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  mathChecks  Json
  mathPassed  Int
  mathFailed  Int

  crossDocChecks   Json
  crossDocPassed   Int
  crossDocFailed   Int
  crossDocWarnings Int

  textractChecks    Json
  textractAgreed    Int
  textractDisagreed Int

  fieldVerification Json
  overallStatus     String

  createdAt DateTime @default(now())
}

// ─── Review Gate ──────────────────────────────────────────────────────────────

model ReviewItem {
  id             String       @id @default(cuid())
  dealId         String
  deal           Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  documentId     String?
  fieldPath      String
  extractedValue String
  expectedValue  String?
  checkType      String
  description    String
  documentPage   Int?
  status         ReviewStatus @default(PENDING)
  resolvedValue  String?
  resolvedBy     String?
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())
}

enum ReviewStatus {
  PENDING
  CONFIRMED
  CORRECTED
  NOTED
}

// ─── Analysis ─────────────────────────────────────────────────────────────────

model Analysis {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  totalGrossIncome   Decimal? @db.Decimal(12, 2)
  totalNetIncome     Decimal? @db.Decimal(12, 2)
  incomeSources      Json
  incomeTrend        String?

  globalDscr   Float?
  propertyDscr Float?
  frontEndDti  Float?
  backEndDti   Float?
  ltv          Float?
  currentRatio Float?
  quickRatio   Float?
  debtToEquity Float?

  avgDailyBalance  Decimal? @db.Decimal(12, 2)
  minBalance       Decimal? @db.Decimal(12, 2)
  monthsOfReserves Float?
  largeDeposits    Json?

  avgMonthlyDeposits Decimal? @db.Decimal(12, 2)
  depositVsIncome    Float?
  nsfCount           Int?

  revenueByYear Json?
  expenseRatio  Float?
  ownerComp     Decimal? @db.Decimal(12, 2)
  addBacks      Json?

  riskFlags Json
  riskScore Float

  fullResults Json

  createdAt DateTime @default(now())
}

// ─── Credit Memo ──────────────────────────────────────────────────────────────

model CreditMemo {
  id        String   @id @default(cuid())
  dealId    String   @unique
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  s3Key     String
  version   Int      @default(1)
  createdAt DateTime @default(now())
}

// ─── Deal Terms (Phase 11: Structuring Output) ──────────────────────────────

model DealTerms {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  loanProgramId String

  // Core terms (set by rules engine)
  approvedAmount    Decimal  @db.Decimal(12, 2)
  interestRate      Float
  termMonths        Int
  amortizationMonths Int
  ltv               Float?
  monthlyPayment    Decimal  @db.Decimal(12, 2)

  // Rate components
  baseRateType      String   // "prime", "sofr", "treasury"
  baseRateValue     Float    // The actual base rate at time of structuring
  spread            Float

  // Flags
  interestOnly       Boolean @default(false)
  prepaymentPenalty  Boolean @default(false)
  personalGuaranty   Boolean @default(false)
  requiresAppraisal  Boolean @default(false)

  // AI-generated content
  covenants       Json     // Array of covenant objects
  conditions      Json     // Pre-closing conditions
  specialTerms    Json?    // AI-recommended special terms
  justification   String?  @db.Text // Narrative justification

  // Compliance
  complianceStatus  String   @default("PENDING") // PENDING, COMPLIANT, NON_COMPLIANT, WAIVED
  complianceIssues  Json?
  complianceReview  Json?    // Full compliance review output

  // Fees
  fees Json // Array of fee objects

  status    String   @default("DRAFT") // DRAFT, PROPOSED, ACCEPTED, LOCKED
  lockedAt  DateTime?
  lockedBy  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Property Details ────────────────────────────────────────────────────────

model PropertyDetails {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  address       String
  city          String?
  state         String?
  zip           String?
  county        String?
  propertyType  String?   // "multifamily", "office", "retail", "industrial", "mixed_use", "1-4_residential"
  yearBuilt     Int?
  squareFeet    Int?
  units         Int?
  lotSize       String?

  // Valuation
  appraisedValue  Decimal? @db.Decimal(12, 2)
  purchasePrice   Decimal? @db.Decimal(12, 2)
  asIsValue       Decimal? @db.Decimal(12, 2)
  afterRepairValue Decimal? @db.Decimal(12, 2)

  // Environmental / Flood
  floodZone     String?
  environmentalPhase1 Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Generated Documents (Phase 12) ─────────────────────────────────────────

model GeneratedDocument {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  docType   String  // "promissory_note", "loan_agreement", "guaranty", etc.
  s3Key     String
  version   Int     @default(1)
  status    String  @default("DRAFT") // DRAFT, REVIEWED, APPROVED, SIGNED

  // Review tracking
  legalReviewStatus String? // PENDING, APPROVED, FLAGGED
  legalIssues       Json?
  verificationStatus String? // PENDING, PASSED, FAILED
  verificationIssues Json?
  complianceChecks   Json?   // Array of ComplianceCheck objects — regulatory provisions checked

  signedBy  String?
  signedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Conditions (Pre-closing checklist) ──────────────────────────────────────

model Condition {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  category    String  // "prior_to_closing", "prior_to_funding", "post_closing"
  description String
  source      String  // "rules_engine", "ai_recommendation", "compliance", "manual"
  priority    String  @default("required") // "required", "recommended", "optional"

  status      String  @default("OPEN") // OPEN, SATISFIED, WAIVED, NOT_APPLICABLE
  satisfiedBy String?
  satisfiedAt DateTime?
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
