generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Organizations & Users

model Organization {
  id         String   @id @default(cuid())
  name       String
  clerkOrgId String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  users      User[]
  deals      Deal[]
  subscription Subscription?
  usageLogs  UsageLog[]

  // Capital, M&A, Syndication, Compliance verticals
  capitalProjects       CapitalProject[]
  maProjects            MAProject[]
  syndicationProjects   SyndicationProject[]
  complianceProjects    ComplianceProject[]

  // Bio vertical
  bioPrograms      BioProgram[]
  bioSubscription  BioSubscription?
  bioUsageLogs     BioUsageLog[]
}

// Billing

model Subscription {
  id                   String    @id @default(cuid())
  orgId                String    @unique
  org                  Organization @relation(fields: [orgId], references: [id])
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  licensePaid          Boolean   @default(false)
  licensePaymentId     String?
  plan                 String    @default("trial") // "trial", "active", "canceled"
  status               String    @default("trialing") // "trialing", "active", "past_due", "canceled", "unpaid"
  maxSeats             Int       @default(25)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model UsageLog {
  id             String       @id @default(cuid())
  orgId          String
  org            Organization @relation(fields: [orgId], references: [id])
  month          String       // "2026-02" format
  dealsProcessed Int          @default(0)
  docsGenerated  Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([orgId, month])
}

// Audit Trail

model AuditLog {
  id        String   @id @default(cuid())
  orgId     String
  userId    String?
  userEmail String?
  dealId    String?
  entityType  String?  // "deal", "capital", "ma", "syndication", "compliance", "bio"
  entityId    String?  // The project/deal ID
  action    String   // "deal.created", "deal.analyzed", "doc.edited", "doc.saved", "terms.approved", "member.invited", "member.removed", "billing.checkout", "billing.canceled", etc.
  target    String?  // What was acted on — e.g. docType, member email, etc.
  metadata  Json?    // Extra context — old/new values, status changes, etc.
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([orgId, createdAt])
  @@index([dealId, createdAt])
  @@index([entityType, entityId, createdAt])
}

model User {
  id        String       @id @default(cuid())
  clerkId   String       @unique
  email     String
  name      String
  role      String       @default("loan_officer")
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id])
  deals       Deal[]
  capitalProjects       CapitalProject[]
  maProjects            MAProject[]
  syndicationProjects   SyndicationProject[]
  complianceProjects    ComplianceProject[]
  bioPrograms BioProgram[]
  createdAt   DateTime     @default(now())
}

// Deals

model Deal {
  id              String     @id @default(cuid())
  borrowerName    String
  loanAmount      Decimal?   @db.Decimal(12, 2)
  loanPurpose     String?
  loanType        String?
  loanProgramId   String?
  selectedOutputDocs  String[]  @default([])
  proposedRate    Float?
  proposedTerm    Int?
  propertyAddress String?
  status          DealStatus @default(UPLOADED)
  errorMessage    String?
  errorStep       String?

  orgId  String
  org    Organization @relation(fields: [orgId], references: [id])
  userId String
  user   User         @relation(fields: [userId], references: [id])

  documents          Document[]
  extractions        Extraction[]
  analysis           Analysis?
  creditMemo         CreditMemo?
  verificationReport VerificationReport?
  reviewItems        ReviewItem[]
  dealTerms          DealTerms?
  propertyDetails    PropertyDetails?
  generatedDocuments GeneratedDocument[]
  conditions         Condition[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DealStatus {
  UPLOADED
  PROCESSING_OCR
  CLASSIFYING
  EXTRACTING
  VERIFYING
  RESOLVING
  NEEDS_REVIEW
  ANALYZING
  GENERATING_MEMO
  STRUCTURING
  NEEDS_TERM_REVIEW
  GENERATING_DOCS
  COMPLETE
  ERROR
}

// Documents

model Document {
  id             String         @id @default(cuid())
  dealId         String
  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  fileName       String
  s3Key          String
  fileSize       Int
  pageCount      Int?
  docType        DocType?
  docYear        Int?
  status         DocumentStatus @default(PENDING)
  isScanned      Boolean        @default(false)
  textractOutput Json?
  ocrText        String?        @db.Text
  extractions    Extraction[]
  createdAt      DateTime       @default(now())

  @@index([dealId])
}

enum DocType {
  FORM_1040
  FORM_1120
  FORM_1120S
  FORM_1065
  SCHEDULE_K1
  W2
  BANK_STATEMENT_CHECKING
  BANK_STATEMENT_SAVINGS
  PROFIT_AND_LOSS
  BALANCE_SHEET
  RENT_ROLL
  OTHER
}

enum DocumentStatus {
  PENDING
  OCR_PROCESSING
  OCR_COMPLETE
  CLASSIFYING
  CLASSIFIED
  EXTRACTING
  EXTRACTED
  VERIFIED
  ERROR
}

// Extractions

model Extraction {
  id               String   @id @default(cuid())
  documentId       String
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  dealId           String
  deal             Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  model            String
  promptVersion    String
  rawResponse      Json
  structuredData   Json
  validationErrors Json?
  tokensUsed       Int      @default(0)
  costUsd          Float    @default(0)
  createdAt        DateTime @default(now())

  @@index([documentId])
}

// Verification

model VerificationReport {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  mathChecks  Json
  mathPassed  Int
  mathFailed  Int

  crossDocChecks   Json
  crossDocPassed   Int
  crossDocFailed   Int
  crossDocWarnings Int

  textractChecks    Json
  textractAgreed    Int
  textractDisagreed Int

  fieldVerification Json
  overallStatus     String

  createdAt DateTime @default(now())
}

// Review Gate

model ReviewItem {
  id             String       @id @default(cuid())
  dealId         String
  deal           Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  documentId     String?
  fieldPath      String
  extractedValue String
  expectedValue  String?
  checkType      String
  description    String
  documentPage   Int?
  status         ReviewStatus @default(PENDING)
  resolvedValue  String?
  resolvedBy     String?
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@index([dealId])
  @@index([documentId])
}

enum ReviewStatus {
  PENDING
  CONFIRMED
  CORRECTED
  NOTED
}

// Analysis

model Analysis {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  totalGrossIncome   Decimal? @db.Decimal(12, 2)
  totalNetIncome     Decimal? @db.Decimal(12, 2)
  incomeSources      Json
  incomeTrend        String?

  globalDscr   Float?
  propertyDscr Float?
  frontEndDti  Float?
  backEndDti   Float?
  ltv          Float?
  currentRatio Float?
  quickRatio   Float?
  debtToEquity Float?

  avgDailyBalance  Decimal? @db.Decimal(12, 2)
  minBalance       Decimal? @db.Decimal(12, 2)
  monthsOfReserves Float?
  largeDeposits    Json?

  avgMonthlyDeposits Decimal? @db.Decimal(12, 2)
  depositVsIncome    Float?
  nsfCount           Int?

  revenueByYear Json?
  expenseRatio  Float?
  ownerComp     Decimal? @db.Decimal(12, 2)
  addBacks      Json?

  riskFlags Json
  riskScore Float

  fullResults Json

  createdAt DateTime @default(now())
}

// Credit Memo

model CreditMemo {
  id        String   @id @default(cuid())
  dealId    String   @unique
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  s3Key     String
  version   Int      @default(1)
  createdAt DateTime @default(now())
}

// Deal Terms (Phase 11: Structuring Output)

model DealTerms {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  loanProgramId String

  // Core terms (set by rules engine)
  approvedAmount    Decimal  @db.Decimal(12, 2)
  interestRate      Float
  termMonths        Int
  amortizationMonths Int
  ltv               Float?
  monthlyPayment    Decimal  @db.Decimal(12, 2)

  // Rate components
  baseRateType      String   // "prime", "sofr", "treasury"
  baseRateValue     Float    // The actual base rate at time of structuring
  spread            Float

  // Flags
  interestOnly       Boolean @default(false)
  prepaymentPenalty  Boolean @default(false)
  personalGuaranty   Boolean @default(false)
  requiresAppraisal  Boolean @default(false)

  // AI-generated content
  covenants       Json     // Array of covenant objects
  conditions      Json     // Pre-closing conditions
  specialTerms    Json?    // AI-recommended special terms
  justification   String?  @db.Text // Narrative justification

  // Compliance
  complianceStatus  String   @default("PENDING") // PENDING, COMPLIANT, NON_COMPLIANT, WAIVED
  complianceIssues  Json?
  complianceReview  Json?    // Full compliance review output

  // Fees
  fees Json // Array of fee objects

  status    String   @default("DRAFT") // DRAFT, PROPOSED, ACCEPTED, LOCKED
  lockedAt  DateTime?
  lockedBy  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Property Details

model PropertyDetails {
  id     String @id @default(cuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  address       String
  city          String?
  state         String?
  zip           String?
  county        String?
  propertyType  String?   // "multifamily", "office", "retail", "industrial", "mixed_use", "1-4_residential"
  yearBuilt     Int?
  squareFeet    Int?
  units         Int?
  lotSize       String?

  // Valuation
  appraisedValue  Decimal? @db.Decimal(12, 2)
  purchasePrice   Decimal? @db.Decimal(12, 2)
  asIsValue       Decimal? @db.Decimal(12, 2)
  afterRepairValue Decimal? @db.Decimal(12, 2)

  // Environmental / Flood
  floodZone     String?
  environmentalPhase1 Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Generated Documents (Phase 12)

model GeneratedDocument {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  docType   String  // "promissory_note", "loan_agreement", "guaranty", etc.
  s3Key     String
  version   Int     @default(1)
  status    String  @default("DRAFT") // DRAFT, REVIEWED, APPROVED, SIGNED

  // Review tracking
  legalReviewStatus String? // PENDING, APPROVED, FLAGGED
  legalIssues       Json?
  verificationStatus String? // PENDING, PASSED, FAILED
  verificationIssues Json?
  complianceChecks   Json?   // Array of ComplianceCheck objects — regulatory provisions checked

  signedBy  String?
  signedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
}

// Conditions (Pre-closing checklist)

model Condition {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  category    String  // "prior_to_closing", "prior_to_funding", "post_closing"
  description String
  source      String  // "rules_engine", "ai_recommendation", "compliance", "manual"
  priority    String  @default("required") // "required", "recommended", "optional"

  status      String  @default("OPEN") // OPEN, SATISFIED, WAIVED, NOT_APPLICABLE
  satisfiedBy String?
  satisfiedAt DateTime?
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ──────────────────────────────────────────────
// Capital (Fund Formation / Private Placements)
// ──────────────────────────────────────────────

enum CapitalProjectStatus {
  CREATED
  GENERATING_DOCS
  COMPLIANCE_REVIEW
  NEEDS_REVIEW
  COMPLETE
  ERROR
}

enum FundType {
  PRIVATE_EQUITY
  VENTURE_CAPITAL
  REAL_ESTATE
  HEDGE_FUND
  CREDIT
  INFRASTRUCTURE
}

enum ExemptionType {
  REG_D_506B
  REG_D_506C
  REG_A_TIER1
  REG_A_TIER2
  REG_CF
}

enum ICAExemption {
  SECTION_3C1
  SECTION_3C7
}

enum DocGenerationStatus {
  DRAFT
  REVIEWED
  APPROVED
  SIGNED
}

enum ComplianceCheckStatus {
  PENDING
  APPROVED
  FLAGGED
  PASSED
  FAILED
}

enum VerificationCheckStatus {
  PENDING
  PASSED
  FAILED
}

enum EntityType {
  LLC
  LP
}

enum AccreditationStatus {
  PENDING
  VERIFIED
  EXPIRED
  FAILED
}

enum InvestorType {
  ACCREDITED_INDIVIDUAL
  ACCREDITED_ENTITY
  QUALIFIED_PURCHASER
  INSTITUTIONAL
  NON_ACCREDITED
}

enum HSRStatus {
  NOT_REQUIRED
  PENDING_FILING
  FILED
  WAITING_PERIOD
  SECOND_REQUEST
  CLEARED
  WITHDRAWN
}

enum TaxStructure {
  SECTION_338H10
  SECTION_338G
  SECTION_1031
  SECTION_368_A
  SECTION_368_B
  SECTION_368_C
  QSBS_1202
  STANDARD
}

model CapitalProject {
  id              String               @id @default(cuid())
  name            String               // e.g. "Fund III Capital Raise"
  status          CapitalProjectStatus @default(CREATED)
  errorMessage    String?
  errorStep       String?

  // Fund Details
  fundName        String               // Legal fund name
  fundType        FundType
  gpEntityName    String               // General Partner entity
  gpStateOfFormation String?

  // Securities
  exemptionType   ExemptionType        @default(REG_D_506B)
  icaExemption    ICAExemption         @default(SECTION_3C1)

  // ERISA — VCOC/REOC elections (avoid "plan asset" status)
  vcocElection    Boolean              @default(false)
  reocElection    Boolean              @default(false)

  // Economics
  targetRaise     Decimal?             @db.Decimal(18, 2)
  minInvestment   Decimal?             @db.Decimal(18, 2)
  managementFee   Float?               // e.g. 0.02 for 2%
  carriedInterest Float?               // e.g. 0.20 for 20%
  preferredReturn Float?               // e.g. 0.08 for 8%
  hurdles         Json?                // Array of hurdle tiers

  // Fund Terms
  fundTermYears   Int?                 // e.g. 10
  investmentPeriod Int?                // Years
  gpCommitment    Decimal?             @db.Decimal(18, 2)

  // Strategy
  investmentStrategy String?           @db.Text
  targetIndustries   Json?             // Array of strings
  geographicFocus    String?

  // Investor limits
  maxInvestors        Int?
  accreditedOnly      Boolean         @default(false)
  nonAccreditedLimit  Int?

  // Form D Filing
  formDFilingDate     DateTime?
  formDAmendmentDate  DateTime?

  // Anti-fraud (Rule 10b-5)
  riskFactorsIncluded    Boolean      @default(false)
  useOfProceedsDisclosed Boolean      @default(false)

  // State blue sky filings
  stateFilings        Json?

  // Key person
  keyPersonProvision  Boolean         @default(false)
  keyPersonNames      Json?

  // Clawback
  clawbackProvision   Boolean         @default(false)

  // Beneficial Ownership Information (BOI) — Corporate Transparency Act
  boiFilingDate           DateTime?
  boiExemptionClaimed     Boolean         @default(false)
  boiExemptionType        String?

  // Audit fields
  updatedBy          String?
  deletedAt          DateTime?

  // Organization
  orgId           String
  org             Organization         @relation(fields: [orgId], references: [id])
  userId          String
  user            User                 @relation(fields: [userId], references: [id])

  // Relations
  capitalDocuments CapitalDocument[]
  capitalInvestors CapitalInvestor[]

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([orgId])
  @@index([userId])
  @@index([orgId, status])
  @@index([orgId, createdAt])
}

model CapitalDocument {
  id              String          @id @default(cuid())
  projectId       String
  project         CapitalProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  docType         String          // "ppm", "subscription_agreement", "operating_agreement", "investor_questionnaire", "side_letter", "form_d_draft"
  s3Key           String
  version         Int             @default(1)
  status          DocGenerationStatus @default(DRAFT)

  complianceStatus   ComplianceCheckStatus?
  complianceIssues   Json?
  verificationStatus VerificationCheckStatus?
  verificationIssues Json?

  createdBy          String?
  updatedBy          String?
  deletedAt          DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([projectId])
  @@unique([projectId, docType, version])
}

model CapitalInvestor {
  id              String              @id @default(cuid())
  projectId       String
  project         CapitalProject      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  investorName    String
  investorType    InvestorType
  accreditationStatus AccreditationStatus @default(PENDING)
  accreditationDate   DateTime?
  accreditationExpiry DateTime?
  accreditationMethod String?

  commitmentAmount    Decimal?        @db.Decimal(18, 2)
  calledAmount        Decimal?        @db.Decimal(18, 2)
  distributedAmount   Decimal?        @db.Decimal(18, 2)

  subscriptionDate    DateTime?
  sideLetterTerms     Json?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([projectId])
  @@index([projectId, accreditationStatus])
  @@unique([projectId, investorName])
}

// ──────────────────────────────────────────────
// MAProject (M&A Transactions / Deals)
// ──────────────────────────────────────────────

enum MAProjectStatus {
  CREATED
  GENERATING_DOCS
  COMPLIANCE_REVIEW
  NEEDS_REVIEW
  COMPLETE
  ERROR
}

enum TransactionType {
  STOCK_PURCHASE
  ASSET_PURCHASE
  MERGER_FORWARD
  MERGER_REVERSE_TRIANGULAR
  MERGER_FORWARD_TRIANGULAR
  REVERSE_MERGER
  TENDER_OFFER
  SECTION_363_SALE
}

model MAProject {
  id                String           @id @default(cuid())
  name              String           // e.g. "Acme Corp Acquisition"
  status            MAProjectStatus  @default(CREATED)
  errorMessage      String?
  errorStep         String?

  // Transaction Structure
  transactionType   TransactionType

  // Parties
  buyerName         String
  buyerEntity       String?          // Legal entity name
  buyerCounsel      String?
  sellerName        String
  sellerEntity      String?
  sellerCounsel     String?

  // Target Company
  targetCompany     String
  targetIndustry    String?
  targetRevenue     Decimal?         @db.Decimal(18, 2)
  targetEbitda      Decimal?         @db.Decimal(18, 2)
  targetEmployees   Int?
  targetState       String?          // State of incorporation

  // Deal Economics
  purchasePrice     Decimal?         @db.Decimal(18, 2)
  cashComponent     Decimal?         @db.Decimal(18, 2)
  stockComponent    Decimal?         @db.Decimal(18, 2)
  sellerNote        Decimal?         @db.Decimal(18, 2)
  earnoutAmount     Decimal?         @db.Decimal(18, 2)
  earnoutTermMonths Int?
  workingCapitalTarget Decimal?      @db.Decimal(18, 2)
  escrowPercent     Float?           // e.g. 0.10 for 10%
  escrowTermMonths  Int?

  // Timeline
  exclusivityDays   Int?             // No-shop period
  dueDiligenceDays  Int?
  targetCloseDate   DateTime?
  outsideDate       DateTime?        // Drop-dead date

  // Governance
  governingLaw      String?          @default("Delaware")
  nonCompeteYears   Int?
  nonCompeteRadius  String?          // e.g. "50 miles"

  // HSR Act
  hsrRequired         Boolean?
  hsrFilingDate       DateTime?
  hsrFilingFee        Decimal?        @db.Decimal(18, 2)
  hsrClearanceDate    DateTime?
  hsrStatus           HSRStatus?

  // Tax Structure
  taxStructure        TaxStructure?
  section338Election  Boolean         @default(false)

  // Insurance
  rwiInsurance        Boolean         @default(false)
  rwiPremiumPercent   Float?

  // Material adverse change
  macDefinition       String?         @db.Text
  macCarveouts        Json?

  // Regulatory approvals
  requiredApprovals   Json?

  // CFIUS — Committee on Foreign Investment in the United States
  cfiusFiling           Boolean         @default(false)
  cfiusFilingDate       DateTime?
  cfiusApprovalDate     DateTime?
  isTIDUSBusiness       Boolean         @default(false) // TID (Technology, Infrastructure, Data) US Business

  // Breakup / termination fee
  breakupFeeAmount      Decimal?        @db.Decimal(18, 2)
  breakupFeePercent     Float?

  // Employee matters
  keyEmployeeRetention   Boolean      @default(false)
  changeOfControlProvisions Boolean   @default(false)

  // Audit fields
  updatedBy          String?
  deletedAt          DateTime?

  // Organization
  orgId             String
  org               Organization     @relation(fields: [orgId], references: [id])
  userId            String
  user              User             @relation(fields: [userId], references: [id])

  // Relations
  maDocuments       MADocument[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([orgId])
  @@index([userId])
  @@index([orgId, status])
  @@index([orgId, createdAt])
}

model MADocument {
  id                String       @id @default(cuid())
  projectId         String
  project           MAProject    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  docType           String       // "loi", "nda", "stock_purchase_agreement", "asset_purchase_agreement", "due_diligence_checklist", "disclosure_schedules"
  s3Key             String
  version           Int          @default(1)
  status            DocGenerationStatus @default(DRAFT)

  complianceStatus   ComplianceCheckStatus?
  complianceIssues   Json?
  verificationStatus VerificationCheckStatus?
  verificationIssues Json?

  createdBy          String?
  updatedBy          String?
  deletedAt          DateTime?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([projectId])
  @@unique([projectId, docType, version])
}

// ──────────────────────────────────────────────
// SyndicationProject (Real Estate Syndication)
// ──────────────────────────────────────────────

enum SyndicationProjectStatus {
  CREATED
  GENERATING_DOCS
  COMPLIANCE_REVIEW
  NEEDS_REVIEW
  COMPLETE
  ERROR
}

enum SyndicationPropertyType {
  MULTIFAMILY
  OFFICE
  RETAIL
  INDUSTRIAL
  MIXED_USE
  SELF_STORAGE
  MOBILE_HOME_PARK
  HOTEL
  NNN_RETAIL
  SENIOR_HOUSING
  STUDENT_HOUSING
  BUILD_TO_RENT
}

model SyndicationProject {
  id                String              @id @default(cuid())
  name              String              // e.g. "Oak Park Apartments Fund"
  status            SyndicationProjectStatus @default(CREATED)
  errorMessage      String?
  errorStep         String?

  // Entity Structure
  entityName        String              // SPV name
  entityType        EntityType          @default(LLC)
  stateOfFormation  String?             @default("Delaware")
  exemptionType     ExemptionType       @default(REG_D_506B) // Reuse from Capital

  // Sponsor
  sponsorName       String
  sponsorEntity     String?
  sponsorEquity     Decimal?            @db.Decimal(18, 2)

  // Property
  propertyName      String?
  propertyAddress   String
  propertyType      SyndicationPropertyType
  units             Int?
  squareFeet        Int?
  yearBuilt         Int?

  // Acquisition
  purchasePrice     Decimal?            @db.Decimal(18, 2)
  renovationBudget  Decimal?            @db.Decimal(18, 2)
  closingCosts      Decimal?            @db.Decimal(18, 2)

  // Capital Stack
  totalEquityRaise  Decimal?            @db.Decimal(18, 2)
  minInvestment     Decimal?            @db.Decimal(18, 2)

  // Financing
  loanAmount        Decimal?            @db.Decimal(18, 2)
  interestRate      Float?
  loanTermYears     Int?
  interestOnly      Boolean             @default(false)
  ioTermMonths      Int?

  // Returns
  preferredReturn   Float?              // e.g. 0.08 for 8%
  projectedHoldYears Int?
  projectedIrr      Float?
  projectedEquityMultiple Float?

  // Fees
  acquisitionFee    Float?              // e.g. 0.02 for 2%
  assetMgmtFee      Float?              // Annual
  dispositionFee    Float?

  // Additional fees
  constructionMgmtFee Float?
  refinancingFee      Float?
  guaranteeFee        Float?
  propertyMgmtFee     Float?

  // Tax
  isQOZ               Boolean         @default(false)
  is1031Exchange       Boolean         @default(false)
  bonusDepreciationPct Float?
  ubtiRisk             Boolean         @default(false)
  passiveLossEligible  Boolean         @default(true)
  repsQualified        Boolean         @default(false)

  // QOZ detail fields (Opportunity Zones — 26 U.S.C. § 1400Z-2)
  qozCertificationDate             DateTime?
  qozNinetyPercentTestDate         DateTime?
  qozSubstantialImprovementDeadline DateTime?
  qozTenYearHoldDate               DateTime?

  // 1031 Exchange detail fields (26 U.S.C. § 1031)
  exchange1031IdentificationDeadline DateTime?
  exchange1031ExchangeDeadline       DateTime?
  exchange1031QualifiedIntermediary  String?
  exchange1031RelinquishedPropertyId String?

  // Form D / Blue Sky
  formDFilingDate      DateTime?
  blueSkyFilings       Json?

  // Sponsor track record
  sponsorTrackRecord   Json?

  // Operating Assumptions
  currentNoi        Decimal?            @db.Decimal(18, 2)
  proFormaNoi       Decimal?            @db.Decimal(18, 2)
  vacancyRate       Float?
  rentGrowthRate    Float?
  expenseGrowthRate Float?
  exitCapRate       Float?

  // Audit fields
  updatedBy          String?
  deletedAt          DateTime?

  // Organization
  orgId             String
  org               Organization        @relation(fields: [orgId], references: [id])
  userId            String
  user              User                @relation(fields: [userId], references: [id])

  // Relations
  syndicationDocuments     SyndicationDocument[]
  waterfallTiers           WaterfallTier[]
  syndicationInvestors     SyndicationInvestor[]
  syndicationDistributions SyndicationDistribution[]

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([orgId])
  @@index([userId])
  @@index([orgId, status])
  @@index([orgId, createdAt])
}

model SyndicationDocument {
  id                String               @id @default(cuid())
  projectId         String
  project           SyndicationProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  docType           String               // "ppm", "operating_agreement", "subscription_agreement", "investor_questionnaire", "pro_forma"
  s3Key             String
  version           Int                  @default(1)
  status            DocGenerationStatus  @default(DRAFT)

  complianceStatus   ComplianceCheckStatus?
  complianceIssues   Json?
  verificationStatus VerificationCheckStatus?
  verificationIssues Json?

  createdBy          String?
  updatedBy          String?
  deletedAt          DateTime?

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([projectId])
  @@unique([projectId, docType, version])
}

model WaterfallTier {
  id          String              @id @default(cuid())
  projectId   String
  project     SyndicationProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  tierOrder   Int
  tierName    String?
  hurdleRate  Float?
  lpSplit     Float
  gpSplit     Float
  description String?

  createdAt   DateTime            @default(now())

  @@index([projectId])
  @@unique([projectId, tierOrder])
}

model SyndicationInvestor {
  id              String              @id @default(cuid())
  projectId       String
  project         SyndicationProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  investorName    String
  investorType    InvestorType
  accreditationStatus AccreditationStatus @default(PENDING)
  accreditationDate   DateTime?
  accreditationExpiry DateTime?
  accreditationMethod String?

  commitmentAmount    Decimal?        @db.Decimal(18, 2)
  paidInAmount        Decimal?        @db.Decimal(18, 2)
  ownershipPercent    Float?

  subscriptionDate    DateTime?
  sideLetterTerms     Json?

  distributions       SyndicationDistribution[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([projectId])
  @@index([projectId, accreditationStatus])
  @@unique([projectId, investorName])
}

model SyndicationDistribution {
  id              String              @id @default(cuid())
  projectId       String
  project         SyndicationProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  investorId      String?
  investor        SyndicationInvestor? @relation(fields: [investorId], references: [id])

  distributionDate DateTime
  totalAmount      Decimal            @db.Decimal(18, 2)
  returnOfCapital  Decimal?           @db.Decimal(18, 2)
  preferredReturn  Decimal?           @db.Decimal(18, 2)
  profitDistribution Decimal?         @db.Decimal(18, 2)

  withholdingAmount Decimal?          @db.Decimal(18, 2)
  withholdingRate   Float?

  distributionType  String?
  notes             String?           @db.Text

  createdAt       DateTime            @default(now())

  @@index([projectId])
  @@index([investorId])
  @@index([projectId, distributionDate])
}

// ──────────────────────────────────────────────
// ComplianceProject (LP Reporting / Fund Admin)
// ──────────────────────────────────────────────

enum ComplianceProjectStatus {
  CREATED
  GENERATING_DOCS
  COMPLIANCE_REVIEW
  NEEDS_REVIEW
  COMPLETE
  ERROR
}

enum ReportType {
  LP_QUARTERLY_REPORT
  CAPITAL_CALL_NOTICE
  DISTRIBUTION_NOTICE
  K1_SUMMARY
  ANNUAL_REPORT
  FORM_ADV_SUMMARY
  CAPITAL_ACCOUNT_STATEMENT
  VALUATION_REPORT
  AUDITED_FINANCIALS
  SIDE_LETTER_SUMMARY
}

model ComplianceProject {
  id                String                  @id @default(cuid())
  name              String                  // e.g. "Q4 2025 LP Report"
  status            ComplianceProjectStatus @default(CREATED)
  errorMessage      String?
  errorStep         String?

  reportType        ReportType

  // Fund Information
  fundName          String
  fundType          FundType?
  vintageYear       Int?
  fundSize          Decimal?                @db.Decimal(18, 2)

  // Reporting Period
  periodStart       DateTime?
  periodEnd         DateTime?
  reportingQuarter  String?                 // "Q1 2026", "Q2 2026", etc.

  // Fund Metrics (for LP reports)
  nav               Decimal?                @db.Decimal(18, 2)
  totalContributions Decimal?               @db.Decimal(18, 2)
  totalDistributions Decimal?               @db.Decimal(18, 2)
  netIrr            Float?
  grossIrr          Float?
  moic              Float?                  // Multiple on Invested Capital
  dpi               Float?                  // Distributions to Paid-In
  rvpi              Float?                  // Residual Value to Paid-In
  tvpi              Float?                  // Total Value to Paid-In

  // Capital Call / Distribution specific
  callAmount        Decimal?                @db.Decimal(18, 2)
  callDueDate       DateTime?
  callPurpose       String?                 @db.Text
  distributionAmount Decimal?               @db.Decimal(18, 2)
  distributionType  String?                 // "return_of_capital", "income", "gain"

  // K-1 specific
  taxYear           Int?
  filingDeadline    DateTime?

  // Portfolio Summary (JSON for flexibility)
  portfolioSummary  Json?                   // Array of {company, invested, fairValue, irr, status}

  // K-1 Extended (IRS Schedule K-1 Form 1065)
  k1OrdinaryIncome       Decimal?    @db.Decimal(18, 2)
  k1NetRentalIncome      Decimal?    @db.Decimal(18, 2)
  k1GuaranteedPayments   Decimal?    @db.Decimal(18, 2)
  k1InterestIncome       Decimal?    @db.Decimal(18, 2)
  k1DividendIncome       Decimal?    @db.Decimal(18, 2)
  k1ShortTermCapGain     Decimal?    @db.Decimal(18, 2)
  k1LongTermCapGain      Decimal?    @db.Decimal(18, 2)
  k1Section1231Gain      Decimal?    @db.Decimal(18, 2)
  k1Section179Deduction  Decimal?    @db.Decimal(18, 2)
  k1OtherDeductions      Decimal?    @db.Decimal(18, 2)
  k1SelfEmploymentIncome Decimal?    @db.Decimal(18, 2)
  k1ForeignTaxPaid       Decimal?    @db.Decimal(18, 2)
  k1AMTItems             Decimal?    @db.Decimal(18, 2)
  k1TaxExemptIncome      Decimal?    @db.Decimal(18, 2)
  k1Distributions        Decimal?    @db.Decimal(18, 2)
  k1EndingCapitalAccount Decimal?    @db.Decimal(18, 2)
  k1UnrecapturedSec1250  Decimal?    @db.Decimal(18, 2)
  k1QBIDeduction         Decimal?    @db.Decimal(18, 2)
  k1UBTI                 Decimal?    @db.Decimal(18, 2)

  // Capital Call Extended
  callDefaultPenalty     Float?
  callDefaultRemedy      String?
  callNoticeRequiredDays Int?
  unfundedCommitments    Decimal?    @db.Decimal(18, 2)

  // Distribution Extended
  withholdingRate        Float?
  withholdingAmount      Decimal?    @db.Decimal(18, 2)
  withholdingType        String?

  // ILPA Alignment
  ilpaCompliant          Boolean     @default(false)
  ilpaTemplate           String?

  // Valuation
  valuationMethodology   String?
  valuationDate          DateTime?
  valuationProvider      String?
  auditorName            String?
  auditDate              DateTime?
  auditOpinion           String?

  // Side letter tracking
  sideLetterId           String?
  sideLetterTerms        Json?

  // Audit fields
  updatedBy          String?
  deletedAt          DateTime?

  // Organization
  orgId             String
  org               Organization            @relation(fields: [orgId], references: [id])
  userId            String
  user              User                    @relation(fields: [userId], references: [id])

  // Relations
  complianceDocuments ComplianceDocument[]

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@index([orgId])
  @@index([userId])
  @@index([orgId, status])
  @@index([orgId, createdAt])
}

model ComplianceDocument {
  id                String              @id @default(cuid())
  projectId         String
  project           ComplianceProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  docType           String              // "lp_quarterly_report", "capital_call_notice", "distribution_notice", "k1_summary", "annual_report", "form_adv_summary"
  s3Key             String
  version           Int                 @default(1)
  status            DocGenerationStatus @default(DRAFT)

  complianceStatus   ComplianceCheckStatus?
  complianceIssues   Json?
  verificationStatus VerificationCheckStatus?
  verificationIssues Json?

  createdBy          String?
  updatedBy          String?
  deletedAt          DateTime?

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([projectId])
  @@unique([projectId, docType, version])
}

// Bio Vertical (separate from lending — shares Org, User, AuditLog only)

model BioSubscription {
  id                   String    @id @default(cuid())
  orgId                String    @unique
  org                  Organization @relation(fields: [orgId], references: [id])
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  stripePriceIdBase    String?   // Stripe price ID for base subscription
  stripePriceIdSeat    String?   // Stripe price ID for per-seat billing
  licensePaid          Boolean   @default(false)
  licensePaymentId     String?
  plan                 String    @default("trial") // "trial", "active", "canceled"
  status               String    @default("trialing") // "trialing", "active", "past_due", "canceled", "unpaid"
  maxSeats             Int       @default(5)
  currentSeats         Int       @default(1)
  pricePerSeat         Int?      // cents/month per additional seat (for display/reference)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model BioUsageLog {
  id                 String       @id @default(cuid())
  orgId              String
  org                Organization @relation(fields: [orgId], references: [id])
  month              String       // "2026-02" format
  programsProcessed  Int          @default(0)
  docsGenerated      Int          @default(0)
  pagesExtracted     Int          @default(0)
  complianceAudits   Int          @default(0)
  aiTokensUsed       Int          @default(0)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@unique([orgId, month])
}

model BioProgram {
  id          String           @id @default(cuid())
  name        String           // e.g. "DEM301 IND Submission"
  toolType    BioToolType      // data_analysis, regulatory_docs, compliance_audit
  status      BioProgramStatus @default(CREATED)
  errorMessage String?
  errorStep    String?

  // Drug / product identification
  drugName    String?          // e.g. "DEM301"
  drugClass   String?          // "adc", "small_molecule", "biologic", "gene_therapy", "cell_therapy", "vaccine"
  target      String?          // e.g. "Nectin-4"
  mechanism   String?          // e.g. "ADC targeting Nectin-4 expressing solid tumors"
  indication  String?          // e.g. "Urothelial carcinoma, solid tumors"
  phase       DrugPhase        @default(PHASE_1) // PRECLINICAL → APPROVED

  // ADC-specific (nullable — only populated for ADC drugClass)
  antibodyType String?         // e.g. "Humanized IgG1"
  linkerType   String?         // e.g. "Cleavable valine-citrulline"
  payloadType  String?         // e.g. "MMAE"
  dar          Float?          // Drug-to-antibody ratio, e.g. 4.0

  // Regulatory identifiers
  indNumber   String?          // FDA IND number
  nctNumber   String?          // ClinicalTrials.gov NCT number
  fdaDivision String?          // "CDER", "CBER"
  sponsorName String?          // Legal sponsor entity

  // Organization
  orgId  String
  org    Organization @relation(fields: [orgId], references: [id])
  userId String
  user   User         @relation(fields: [userId], references: [id])

  // Relations
  bioDocuments          BioDocument[]
  bioExtractions        BioExtraction[]
  bioAnalysis           BioAnalysis?
  bioParameters         BioParameters?
  bioGeneratedDocuments BioGeneratedDocument[]
  bioConditions         BioCondition[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum BioToolType {
  DATA_ANALYSIS       // Extract + verify + analyze lab/clinical data
  REGULATORY_DOCS     // Generate IND sections, protocols, IB, CMC summaries
  COMPLIANCE_AUDIT    // Check existing docs against FDA regs (21 CFR Part 11, GLP, GMP)
}

enum BioProgramStatus {
  CREATED
  UPLOADING
  EXTRACTING
  CLASSIFYING
  VERIFYING
  ANALYZING
  GENERATING_DOCS
  COMPLIANCE_REVIEW
  NEEDS_REVIEW
  COMPLETE
  ERROR
}

enum DrugPhase {
  PRECLINICAL
  IND_FILING
  PHASE_1
  PHASE_1B
  PHASE_2
  PHASE_2B
  PHASE_3
  NDA_BLA
  APPROVED
  POST_MARKET
}

model BioDocument {
  id             String            @id @default(cuid())
  programId      String
  program        BioProgram        @relation(fields: [programId], references: [id], onDelete: Cascade)
  fileName       String
  s3Key          String
  fileSize       Int
  pageCount      Int?
  docType        BioDocType?
  status         BioDocumentStatus @default(PENDING)
  textractOutput Json?
  ocrText        String?           @db.Text
  extractions    BioExtraction[]
  createdAt      DateTime          @default(now())
}

enum BioDocType {
  // Manufacturing & Quality (CMC)
  BATCH_RECORD
  CERTIFICATE_OF_ANALYSIS
  STABILITY_DATA
  MANUFACTURING_PROCESS
  RAW_MATERIAL_SPEC
  DRUG_SUBSTANCE_SPEC
  DRUG_PRODUCT_SPEC
  ANALYTICAL_METHOD_VALIDATION

  // Nonclinical
  TOXICOLOGY_REPORT
  PHARMACOLOGY_REPORT
  PK_STUDY                // Pharmacokinetics
  PD_STUDY                // Pharmacodynamics
  ADME_STUDY              // Absorption, distribution, metabolism, excretion
  GENOTOXICITY_REPORT
  CARCINOGENICITY_REPORT

  // Clinical
  CLINICAL_PROTOCOL
  CLINICAL_STUDY_REPORT
  SAFETY_REPORT
  ADVERSE_EVENT_REPORT
  INFORMED_CONSENT_FORM
  CASE_REPORT_FORM

  // Regulatory
  REGULATORY_CORRESPONDENCE
  MEETING_MINUTES_FDA
  ANNUAL_REPORT
  IND_SAFETY_REPORT

  // General
  STANDARD_OPERATING_PROCEDURE
  QUALITY_MANUAL
  VALIDATION_REPORT
  AUDIT_REPORT
  BIO_OTHER
}

enum BioDocumentStatus {
  PENDING
  OCR_PROCESSING
  OCR_COMPLETE
  CLASSIFYING
  CLASSIFIED
  EXTRACTING
  EXTRACTED
  VERIFIED
  ERROR
}

model BioExtraction {
  id             String      @id @default(cuid())
  documentId     String
  document       BioDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  programId      String
  program        BioProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)
  model          String      // AI model used
  promptVersion  String
  rawResponse    Json
  structuredData Json        // Typed per BioDocType (CMC fields, PK parameters, tox endpoints, etc.)
  validationErrors Json?
  tokensUsed     Int         @default(0)
  costUsd        Float       @default(0)
  createdAt      DateTime    @default(now())
}

model BioAnalysis {
  id        String     @id @default(cuid())
  programId String     @unique
  program   BioProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  // CMC Summary
  cmcData          Json?  // Formulation, manufacturing process, controls, specifications
  stabilityProfile Json?  // Stability conditions, timepoints, results, shelf life

  // Nonclinical Summary
  toxSummary     Json?    // NOAEL, LOAEL, MTD, target organs, dose-limiting toxicities
  pkSummary      Json?    // Cmax, AUC, t½, clearance, Vd, bioavailability
  safetyMargins  Json?    // Human-equivalent dose calculations, safety multiples

  // ADC-Specific Analytics (nullable)
  darDistribution  Json?  // DAR species distribution, average DAR, conjugation efficiency
  freePayload      Float? // Unconjugated payload percentage
  adccPotency      Float? // Antibody-dependent cellular cytotoxicity
  bindingAffinity  Json?  // Kd, kon, koff for target binding
  internalization  Json?  // Rate and efficiency of ADC internalization

  // Clinical Summary (if applicable)
  clinicalData   Json?    // Efficacy endpoints, response rates, survival data
  adverseEvents  Json?    // AE frequency, grade, relatedness
  doseEscalation Json?    // DLT, MTD, RP2D (Project Optimus)

  // Risk Assessment
  riskFlags      Json?    // Identified risks and concerns
  riskScore      Float?
  regulatoryFlags Json?   // Specific FDA requirements triggered

  // Full computed results
  fullResults    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BioParameters {
  id        String     @id @default(cuid())
  programId String     @unique
  program   BioProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  // Dosing & Formulation
  routeOfAdmin     String?  // "IV", "SC", "oral", "intrathecal"
  doseRange        String?  // e.g. "0.3 - 10 mg/kg"
  dosingSchedule   String?  // e.g. "Q3W" (every 3 weeks)
  formulation      String?  // e.g. "Lyophilized powder for IV infusion"

  // Manufacturing
  manufacturer     String?
  manufacturingSite String?
  batchSize        String?
  scaleUpStatus    String?  // "lab", "pilot", "commercial"

  // Regulatory Strategy
  regulatoryPathway String? // "505(b)(1)", "505(b)(2)", "351(a)", "351(k)"
  designations      Json?   // Orphan drug, fast track, breakthrough therapy, accelerated approval
  specialProtocol   Boolean @default(false)

  // Study Design (for clinical programs)
  studyDesign        String? // "open-label dose escalation", "randomized double-blind", etc.
  primaryEndpoint    String?
  secondaryEndpoints Json?
  sampleSize         Int?
  enrollmentStatus   String? // "not_started", "enrolling", "fully_enrolled", "completed"

  // Compliance Status
  complianceStatus String  @default("PENDING") // PENDING, COMPLIANT, NON_COMPLIANT, WAIVED
  complianceIssues Json?
  complianceReview Json?

  status    String   @default("DRAFT") // DRAFT, PROPOSED, ACCEPTED, LOCKED
  lockedAt  DateTime?
  lockedBy  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BioGeneratedDocument {
  id        String     @id @default(cuid())
  programId String
  program   BioProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  docType   String     // "ind_module_1", "ind_module_2_quality", "investigator_brochure", etc.
  s3Key     String
  version   Int        @default(1)
  status    String     @default("DRAFT") // DRAFT, REVIEWED, APPROVED, SIGNED

  // Compliance & Review
  complianceStatus   String? // PENDING, PASSED, FLAGGED
  complianceIssues   Json?
  verificationStatus String? // PENDING, PASSED, FAILED
  verificationIssues Json?
  regulatoryChecks   Json?   // FDA requirement checks (21 CFR Part 11, GLP, GMP, etc.)

  // 21 CFR Part 11 — Electronic Signatures
  signedBy         String?   // User ID / name of signer
  signedByTitle    String?   // e.g. "VP Regulatory Affairs", "Medical Director"
  signedByEmail    String?
  signatureReason  String?   // "I have reviewed and approve this document"
  signedAt         DateTime?
  signatureMethod  String?   // "electronic", "wet_ink", "digital_certificate"

  // Review chain (Part 11 requires documented review)
  reviewedBy       String?
  reviewedByTitle  String?
  reviewedAt       DateTime?
  reviewNotes      String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([programId])
  @@unique([programId, docType, version])
}

model BioCondition {
  id        String     @id @default(cuid())
  programId String
  program   BioProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  category    String   // "pre_ind", "ind_submission", "clinical_hold", "post_approval", "manufacturing"
  description String
  regulation  String?  // e.g. "21 CFR 312.23(a)(8)", "ICH E6(R2) Section 4.5"
  source      String   // "fda_requirement", "ich_guideline", "rules_engine", "ai_recommendation", "manual"
  priority    String   @default("required") // "required", "recommended", "optional"

  status      String   @default("OPEN") // OPEN, SATISFIED, WAIVED, NOT_APPLICABLE
  satisfiedBy String?
  satisfiedAt DateTime?
  evidence    String?  @db.Text  // Link to or description of evidence satisfying the condition
  notes       String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
